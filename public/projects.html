<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Tous mes projets | Yggdrasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="flex min-h-screen">
    <div id="sidebar-container"></div>

    <main class="flex-grow p-10 max-w-5xl mx-auto">
        <h1 class="text-5xl font-black italic uppercase tracking-tighter mb-10">Archives Projets</h1>
        <div id="all-projects-list" class="space-y-4">
        </div>
    </main>

    <script src="/js/navigation.js"></script>
    <script>
        async function initPage() {
            const token = localStorage.getItem('yggdrasil_token');
            if (!token) return window.location.href = '/';

            const res = await fetch('/api/projects-list', { headers: { 'Authorization': 'Bearer ' + token } });
            const projects = await res.json();
            const container = document.getElementById('all-projects-list');

            container.innerHTML = '';
            for (let p of projects) {
                const resDet = await fetch(`/api/project-details/${encodeURIComponent(p.name)}`, { headers: { 'Authorization': 'Bearer ' + token } });
                const details = await resDet.json();
                container.innerHTML += `
                    <div class="glass-card p-6 rounded-2xl flex items-center justify-between hover:border-emerald-500/50 transition group relative">
                        <a href="/project.html?name=${p.name}" class="absolute inset-0 z-0"></a>
                        <div class="flex items-center gap-6 z-10">
                            <div class="w-12 h-12 bg-slate-900 rounded-xl flex items-center justify-center border border-white/5 cursor-pointer hover:bg-slate-800 transition" onclick="toggleFavList(event, '${p.id}', ${p.is_favorite})">
                                <i class="${p.is_favorite ? 'fa-solid text-yellow-500' : 'fa-regular text-slate-500'} fa-star"></i>
                            </div>
                            <div class="pointer-events-none">
                                <h3 class="text-lg font-bold group-hover:text-emerald-400 transition">${p.name}</h3>
                                <span class="text-[10px] uppercase font-bold text-slate-500">${p.status}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-6 z-10">
                             <div class="text-right pointer-events-none">
                                <div class="text-sm font-black text-emerald-400 font-mono">${details.progress}%</div>
                                <div class="w-24 bg-slate-800 h-1 rounded-full mt-2"><div class="bg-emerald-500 h-full" style="width: ${details.progress}%"></div></div>
                            </div>
                            <button onclick="deleteProjectList(event, '${p.id}')" class="w-10 h-10 rounded-xl flex items-center justify-center text-slate-600 hover:text-red-500 hover:bg-red-500/10 transition">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function toggleFavList(e, id, currentVal) {
            e.stopPropagation(); // prevent navigation
            e.preventDefault();
            await fetch('/api/project-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('yggdrasil_token') },
                body: JSON.stringify({ id: id, is_favorite: !currentVal })
            });
            initPage();
        }

        async function deleteProjectList(e, id) {
            e.stopPropagation();
            e.preventDefault();
            if (!confirm("Supprimer ce projet ?")) return;
            await fetch(`/api/projects/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('yggdrasil_token') }
            });
            initPage();
        }
        window.onload = () => includeSidebar().then(initPage);
    </script>
</body>

</html>