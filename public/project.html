<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Projet | Yggdrasil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .task-col {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 1.5rem;
            min-height: 500px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(6px);
        }

        select option {
            background: #1e293b;
            color: white;
        }

        .markdown-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content strong {
            font-weight: bold;
            color: #a78bfa;
        }

        .markdown-content p {
            margin-bottom: 0.5rem;
        }

        .markdown-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .markdown-content code {
            font-family: monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.1rem 0.3rem;
            border-radius: 0.2rem;
            font-size: 0.9em;
        }
    </style>
</head>

<body class="flex min-h-screen">
    <div id="sidebar-container"></div>

    <div id="task-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-3xl p-8 border border-emerald-500/30 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Édition de mission</span>
                <button onclick="closeTaskModal()" class="text-slate-500 hover:text-white text-2xl">&times;</button>
            </div>
            <input type="hidden" id="modal-task-id">
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 lg:col-span-1">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Titre</label>
                        <input type="text" id="modal-task-title"
                            class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none font-bold">
                    </div>
                    <div class="col-span-2 lg:col-span-1">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">État</label>
                        <select id="modal-task-status"
                            class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none cursor-pointer">
                            <option value="todo">À Faire</option>
                            <option value="in_progress">En Cours</option>
                            <option value="done">Terminé</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Notes techniques</label>
                    <textarea id="modal-task-long-desc"
                        class="w-full h-48 bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none text-slate-300 resize-none"></textarea>
                </div>
                <div class="flex gap-4">
                    <button onclick="saveTaskDetails()"
                        class="flex-grow bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold transition">Enregistrer</button>
                    <button onclick="deleteTask()"
                        class="px-6 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl transition border border-red-500/20"><i
                            class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-grow p-10 max-w-7xl mx-auto w-full">
        <div class="flex justify-between items-center mb-10">
            <div>
                <select id="p-status-select" onchange="updateProjectStatus(this.value)"
                    class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 text-[10px] font-bold uppercase rounded-full px-3 py-1 outline-none cursor-pointer">
                    <option value="En cours">En cours</option>
                    <option value="En pause">En pause</option>
                    <option value="Terminé">Terminé</option>
                </select>
                <h1 id="p-name" class="text-6xl font-black tracking-tighter uppercase italic text-white mt-4">...</h1>
            </div>
            <div class="glass-card p-6 rounded-3xl flex items-center gap-6">
                <div class="text-right">
                    <p id="p-status-text" class="text-2xl font-black text-emerald-400 italic">0% STABLE</p>
                </div>
                <div class="relative w-16 h-16 flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent"
                            class="text-slate-800" />
                        <circle id="p-progress-circle" cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4"
                            fill="transparent" stroke-dasharray="175.9" stroke-dashoffset="175.9"
                            class="text-emerald-500 transition-all duration-1000" />
                    </svg>
                    <span id="p-progress-label" class="absolute text-[10px] font-bold text-white">0%</span>
                </div>
            </div>
        </div>

        <!-- Project Controls -->
        <div class="flex gap-4 mb-8 justify-end">
            <button onclick="toggleFavorite()" id="btn-favorite"
                class="bg-slate-800 hover:bg-slate-700 text-slate-400 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-white/5">
                <i class="fa-regular fa-star"></i> Favori
            </button>
            <button onclick="openEditProjectModal()"
                class="bg-slate-800 hover:bg-slate-700 text-slate-400 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-white/5">
                <i class="fa-solid fa-pen"></i> Modifier
            </button>
            <button onclick="deleteProject()"
                class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-red-500/20">
                <i class="fa-solid fa-trash"></i> Supprimer
            </button>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex gap-8 mb-8 border-b border-white/5">
            <button
                class="tab-btn px-4 py-2 text-sm font-bold uppercase tracking-widest text-emerald-500 border-b-2 border-emerald-500 transition-all hover:text-white"
                data-tab="missions" onclick="switchTab('missions')">Missions</button>
            <button
                class="tab-btn px-4 py-2 text-sm font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent transition-all hover:text-white"
                data-tab="presentation" onclick="switchTab('presentation')"><i
                    class="fa-solid fa-circle-info mr-2"></i>Présentation</button>
            <button
                class="tab-btn px-4 py-2 text-sm font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent transition-all hover:text-white"
                data-tab="brainstorm" onclick="switchTab('brainstorm')"><i
                    class="fa-solid fa-wand-magic-sparkles mr-2"></i>Brainstorming IA</button>
            <button
                class="tab-btn px-4 py-2 text-sm font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent transition-all hover:text-white"
                data-tab="logs" onclick="switchTab('logs')">Mémoire Technique</button>
        </div>

        <!-- PRESENTATION VIEW -->
        <div id="view-presentation" class="hidden animate-in fade-in duration-300">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Description -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-card p-8 rounded-3xl border border-white/5">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">À propos du
                            projet</h3>
                        <p id="p-desc-display" class="text-slate-300 leading-relaxed whitespace-pre-wrap">Aucune
                            description.</p>
                    </div>
                </div>

                <!-- Liens / Ressources -->
                <div class="space-y-6">
                    <div class="glass-card p-6 rounded-3xl border border-white/5">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Ressources &
                                Liens</h3>
                            <button onclick="document.getElementById('add-link-form').classList.toggle('hidden')"
                                class="text-slate-400 hover:text-white transition"><i
                                    class="fa-solid fa-plus"></i></button>
                        </div>

                        <!-- Add Link Form -->
                        <div id="add-link-form"
                            class="hidden mb-6 p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <select id="new-link-type"
                                class="w-full bg-slate-800 text-xs text-white p-2 rounded-lg mb-2 outline-none border border-white/10">
                                <option value="GitHub">GitHub</option>
                                <option value="Documentation">Documentation</option>
                                <option value="Design">Design / Figma</option>
                                <option value="Déploiement">Déploiement / Prod</option>
                                <option value="Autre">Autre</option>
                            </select>
                            <input type="text" id="new-link-url" placeholder="URL (https://...)"
                                class="w-full bg-slate-800 text-xs text-white p-2 rounded-lg mb-2 outline-none border border-white/10">
                            <button onclick="addProjectLink()"
                                class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg text-xs font-bold transition">Ajouter</button>
                        </div>

                        <div id="project-links-list" class="space-y-3">
                            <!-- Links injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MISSIONS VIEW -->
        <div id="view-missions" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in duration-300">
            <div class="task-col p-6 border border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">À Faire</h3>
                    <button onclick="showTaskInput()" class="text-emerald-500 hover:text-white transition"><i
                            class="fa-solid fa-plus-circle"></i></button>
                </div>

                <div id="quick-task-input" class="hidden mb-4">
                    <input type="text" id="new-task-title" onkeyup="if(event.key === 'Enter') submitNewTask()"
                        placeholder="Nom de la tâche + Enter"
                        class="w-full bg-slate-900/80 border border-emerald-500/30 rounded-xl px-4 py-3 text-sm outline-none focus:border-emerald-500 shadow-lg shadow-emerald-500/5">
                </div>

                <div id="tasks-todo" class="space-y-3"></div>
            </div>
            <div class="task-col p-6 border border-emerald-500/10">
                <h3 class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-6">En Cours</h3>
                <div id="tasks-in_progress" class="space-y-3"></div>
            </div>
            <div class="task-col p-6 border border-white/5 opacity-60">
                <h3 class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-6">Terminé</h3>
                <div id="tasks-done" class="space-y-3"></div>
            </div>
        </div>

        <!-- BRAINSTORM VIEW -->
        <div id="view-brainstorm"
            class="hidden animate-in fade-in duration-300 grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
            <!-- Chat Column (2/3) -->
            <div class="lg:col-span-2 flex flex-col glass-card rounded-2xl overflow-hidden border border-white/5">
                <div id="chat-history" class="flex-grow p-6 overflow-y-auto space-y-4 custom-scrollbar">
                    <!-- Messages injectés ici -->
                    <div class="text-center text-slate-500 text-sm mt-10">
                        <i class="fa-solid fa-robot text-4xl mb-4 opacity-50"></i>
                        <p>Commencez une session de brainstorming avec l'IA...</p>
                    </div>
                </div>
                <div class="p-4 bg-slate-900/50 border-t border-white/5 flex gap-4">
                    <input type="text" id="chat-input"
                        class="flex-grow bg-slate-800/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none focus:border-purple-500 transition"
                        placeholder="Posez une question ou discutez d'une idée..."
                        onkeyup="if(event.key === 'Enter') sendBrainstormMessage()">
                    <button onclick="sendBrainstormMessage()"
                        class="bg-purple-600 hover:bg-purple-500 text-white px-6 rounded-xl font-bold transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Suggestions Column (1/3) -->
            <div class="glass-card rounded-2xl p-6 border border-purple-500/20 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">Suggestions IA</h3>
                    <span id="suggestion-count"
                        class="bg-purple-500/20 text-purple-400 text-xs font-bold px-2 py-1 rounded-lg">0</span>
                </div>
                <div id="suggestions-list" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar">
                    <p class="text-center text-slate-500 text-xs italic mt-10">Les tâches suggérées apparaîtront ici...
                    </p>
                </div>
            </div>
        </div>

        <!-- LOGS VIEW -->
        <div id="view-logs" class="hidden animate-in fade-in duration-300">
            <div class="flex justify-end mb-6">
                <button onclick="openLogModal()"
                    class="bg-purple-600/20 hover:bg-purple-600 text-purple-400 hover:text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition flex items-center gap-2 border border-purple-500/30">
                    <i class="fa-solid fa-pen-nib"></i> Écrire une entrée
                </button>
            </div>
            <div id="logs-container" class="space-y-4 max-w-4xl mx-auto"></div>
        </div>
    </main>

    <script src="/js/navigation.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name') || 'Aurora';
        let projectId = null;
        let allTasks = [];
        let token = null;

        async function initPage() {
            token = localStorage.getItem('yggdrasil_token');
            if (!token) return window.location.href = '/';

            const res = await fetch(`/api/project-details/${encodeURIComponent(name)}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.status === 401 || res.status === 403) {
                localStorage.removeItem('yggdrasil_token');
                return window.location.href = '/';
            }
            if (!res.ok) return alert("Projet introuvable ou accès refusé");

            const p = await res.json();
            projectId = p.id;
            allTasks = p.tasks;

            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-desc-display').innerText = p.description || "Aucune description.";
            document.getElementById('p-status-select').value = p.status;
            document.getElementById('p-status-text').innerText = p.progress + "% STABLE";
            document.getElementById('p-progress-label').innerText = p.progress + "%";
            document.getElementById('p-progress-circle').style.strokeDashoffset = 175.9 - (p.progress / 100 * 175.9);

            updateFavoriteUI(p.is_favorite);

            renderTasks(p.tasks);
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateFavoriteUI(isFav) {
            const btn = document.getElementById('btn-favorite');
            if (isFav) {
                btn.innerHTML = '<i class="fa-solid fa-star text-yellow-500"></i> Favori';
                btn.classList.add('text-yellow-500', 'border-yellow-500/30', 'bg-yellow-500/10');
            } else {
                btn.innerHTML = '<i class="fa-regular fa-star"></i> Favori';
                btn.classList.remove('text-yellow-500', 'border-yellow-500/30', 'bg-yellow-500/10');
            }
        }

        async function toggleFavorite() {
            // Assume current state is correct in DOM for simple toggle
            const isFav = document.getElementById('btn-favorite').querySelector('.fa-solid') !== null;
            const newState = !isFav;

            try {
                await fetch('/api/project-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ id: projectId, is_favorite: newState })
                });
                updateFavoriteUI(newState);
                // Refresh Sidebar
                if (window.updateSidebarContent) window.updateSidebarContent();
            } catch (e) { console.error(e); }
        }

        async function deleteProject() {
            if (!confirm("ATTENTION : Cette action est irréversible. Tout le projet (tâches, logs, etc.) sera supprimé. Continuer ?")) return;

            try {
                const res = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) window.location.href = '/projects.html';
                else alert("Erreur lors de la suppression");
            } catch (e) { console.error(e); }
        }

        // Edit Modal Logic
        function openEditProjectModal() {
            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('edit-project-name').value = document.getElementById('p-name').innerText;
            document.getElementById('edit-project-desc').value = document.getElementById('p-desc-display').innerText;
            document.getElementById('edit-project-modal').classList.remove('hidden');
        }

        function closeEditProjectModal() {
            document.getElementById('edit-project-modal').classList.add('hidden');
        }

        async function submitEditProject() {
            const name = document.getElementById('edit-project-name').value;
            const desc = document.getElementById('edit-project-desc').value;

            await fetch('/api/project-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ id: projectId, name: name, description: desc })
            });
            // If name changed, reload to update URL query param or just reload same page if ID is used? 
            // Current URL uses name. So we must redirect if name changes.
            window.location.href = `/project.html?name=${encodeURIComponent(name)}`;
        }

        function renderTasks(tasks) {
            ['todo', 'in_progress', 'done'].forEach(status => {
                document.getElementById(`tasks-${status}`).innerHTML = tasks.filter(t => t.status === status).map(t => `
                    <div onclick="openTaskModal(${t.id})" class="p-4 bg-slate-900/40 border border-white/5 rounded-2xl cursor-pointer hover:border-emerald-500/50 transition">
                        <span class="text-sm text-slate-300 font-medium">${escapeHtml(t.description)}</span>
                    </div>
                `).join('');
            });
        }

        function showTaskInput() {
            document.getElementById('quick-task-input').classList.remove('hidden');
            document.getElementById('new-task-title').focus();
        }

        async function submitNewTask() {
            const desc = document.getElementById('new-task-title').value;
            if (!desc) return;

            await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ project_id: projectId, description: desc })
            });
            window.location.reload();
        }

        function openTaskModal(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            document.getElementById('modal-task-id').value = task.id;
            document.getElementById('modal-task-title').value = task.description;
            document.getElementById('modal-task-status').value = task.status;
            document.getElementById('modal-task-long-desc').value = task.long_description || "";
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function closeTaskModal() { document.getElementById('task-modal').classList.add('hidden'); }

        async function saveTaskDetails() {
            const id = document.getElementById('modal-task-id').value;
            const title = document.getElementById('modal-task-title').value;
            const status = document.getElementById('modal-task-status').value;
            const longDesc = document.getElementById('modal-task-long-desc').value;
            await fetch('/api/tasks/update-details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ id, description: title, long_description: longDesc, status })
            });
            window.location.reload();
        }

        async function deleteTask() {
            const id = document.getElementById('modal-task-id').value;
            if (!confirm("Supprimer cette tâche ?")) return;
            await fetch('/api/tasks/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ id })
            });
            window.location.reload();
        }

        async function updateProjectStatus(status) {
            await fetch('/api/project-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ id: projectId, status })
            });
        }

        // Lancement avec chargement de la sidebar
        window.onload = () => includeSidebar().then(initPage);

        // --- LOGS FEATURE ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                if (b.dataset.tab === tab) {
                    b.classList.add('text-emerald-500', 'border-b-2', 'border-emerald-500');
                    b.classList.remove('text-slate-400', 'border-transparent');
                } else {
                    b.classList.remove('text-emerald-500', 'border-b-2', 'border-emerald-500');
                    b.classList.add('text-slate-400', 'border-transparent');
                }
            });
            if (tab === 'missions') {
                document.getElementById('view-missions').classList.remove('hidden');
                document.getElementById('view-presentation').classList.add('hidden');
                document.getElementById('view-brainstorm').classList.add('hidden');
                document.getElementById('view-logs').classList.add('hidden');
            } else if (tab === 'presentation') {
                document.getElementById('view-missions').classList.add('hidden');
                document.getElementById('view-presentation').classList.remove('hidden');
                document.getElementById('view-brainstorm').classList.add('hidden');
                document.getElementById('view-logs').classList.add('hidden');
                loadProjectLinks();
            } else if (tab === 'brainstorm') {
                document.getElementById('view-missions').classList.add('hidden');
                document.getElementById('view-presentation').classList.add('hidden');
                document.getElementById('view-brainstorm').classList.remove('hidden');
                document.getElementById('view-logs').classList.add('hidden');
                loadBrainstormHistory();
            } else {
                document.getElementById('view-missions').classList.add('hidden');
                document.getElementById('view-presentation').classList.add('hidden');
                document.getElementById('view-brainstorm').classList.add('hidden');
                document.getElementById('view-logs').classList.remove('hidden');
                loadLogs();
            }
        }

        // --- LINKS FEATURE ---
        async function loadProjectLinks() {
            try {
                const res = await fetch(`/api/projects/${projectId}/links`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const links = await res.json();
                renderLinks(links);
            } catch (err) { console.error("Error loading links", err); }
        }

        function renderLinks(links) {
            const container = document.getElementById('project-links-list');
            if (links.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-500 italic text-center py-4">Aucun lien ajouté.</p>';
                return;
            }
            container.innerHTML = links.map(l => {
                let icon = 'fa-link';
                // Auto icon
                if (l.type === 'GitHub') icon = 'fa-github';
                if (l.type === 'Documentation') icon = 'fa-book';
                if (l.type === 'Design') icon = 'fa-pen-ruler';
                if (l.type === 'Déploiement') icon = 'fa-rocket';

                let colorClass = 'text-slate-400 group-hover:text-emerald-400';
                if (l.type === 'GitHub') colorClass = 'text-slate-400 group-hover:text-white';
                if (l.type === 'Déploiement') colorClass = 'text-emerald-500 group-hover:text-emerald-300';

                return `
                <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg group hover:bg-slate-800 transition border border-transparent hover:border-white/10">
                    <a href="${l.url}" target="_blank" class="flex items-center gap-3 flex-grow">
                        <div class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center ${colorClass} transition"><i class="fa-brands ${icon} ${icon.startsWith('fa-') ? 'fa-solid' : ''}"></i></div>
                        <div>
                            <div class="text-xs font-bold text-slate-300 group-hover:text-white transition uppercase tracking-wider">${l.type}</div>
                            <div class="text-[10px] text-slate-500 truncate max-w-[150px]">${l.url}</div>
                        </div>
                    </a>
                    <button onclick="deleteLink(${l.id})" class="text-slate-600 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>
                `;
            }).join('');
        }

        async function addProjectLink() {
            const type = document.getElementById('new-link-type').value;
            const url = document.getElementById('new-link-url').value;
            if (!url) return;

            await fetch(`/api/projects/${projectId}/links`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ type, url })
            });

            document.getElementById('new-link-url').value = '';
            document.getElementById('add-link-form').classList.add('hidden');
            loadProjectLinks();
        }

        async function deleteLink(id) {
            if (!confirm("Supprimer ce lien ?")) return;
            await fetch(`/api/links/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            loadProjectLinks();
        }

        // --- BRAINSTORMING LOGIC ---
        let isBrainstormLoaded = false;

        async function loadBrainstormHistory() {
            if (isBrainstormLoaded) return;
            const container = document.getElementById('chat-history');
            const suggestionsList = document.getElementById('suggestions-list');

            // Clear current (keep placeholder if empty logic needed later, but here raw rewrite is easiest)
            // But we have a placeholder "Commencez..." in HTML, we should keep it if empty.
            // Let's fetch first.
            try {
                const res = await fetch(`/api/projects/${projectId}/brainstorm`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                // 1. Load History
                if (data.history && data.history.length > 0) {
                    container.innerHTML = ''; // Clear placeholder
                    data.history.forEach(h => {
                        // Backend format: { role: 'user', parts: [{ text: '...' }] }
                        appendMessage(h.role, h.parts[0].text);
                    });
                }

                // 2. Load Suggestions
                suggestionsList.innerHTML = '<p class="text-center text-slate-500 text-xs italic mt-10">Les tâches suggérées apparaîtront ici...</p>'; // Reset
                if (data.suggestions && data.suggestions.length > 0) {
                    suggestionsList.innerHTML = '';
                    data.suggestions.forEach(s => addSuggestionCard(s));
                    updateSuggestionCount();
                }

                isBrainstormLoaded = true;
                container.scrollTop = container.scrollHeight;

            } catch (err) {
                console.error("Failed to load brainstorm", err);
            }
        }

        async function sendBrainstormMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // User UI
            appendMessage('user', msg);
            input.value = '';

            // Loading UI
            const loadingId = appendMessage('ai', 'Thinking...', true);

            try {
                const res = await fetch('/api/brainstorm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({
                        project_id: projectId,
                        project_name: document.getElementById('p-name').innerText,
                        project_desc: "",
                        current_tasks: allTasks.map(t => t.description),
                        message: msg,
                        history: [] // Legacy param, backend uses DB now if empty
                    })
                });

                const data = await res.json();
                document.getElementById(loadingId).remove();

                if (data.error) {
                    appendMessage('error', data.error);
                } else {
                    appendMessage('ai', data.reply);
                    if (data.suggestions && data.suggestions.length > 0) {
                        if (document.getElementById('suggestions-list').querySelector('.text-center')) {
                            document.getElementById('suggestions-list').innerHTML = '';
                        }
                        data.suggestions.forEach(addSuggestionCard);
                        updateSuggestionCount();
                    }
                }
            } catch (err) {
                document.getElementById(loadingId).remove();
                appendMessage('error', "Erreur de communication");
            }
        }

        function appendMessage(role, text, isLoading = false) {
            const container = document.getElementById('chat-history');
            const id = 'msg-' + Date.now() + Math.random();

            const isUser = role === 'user';
            // Supprimer le placeholder si c'est le premier message
            const placeholder = container.querySelector('.text-center');
            if (placeholder) placeholder.remove();

            const html = `
                <div id="${id}" class="flex gap-4 ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-full ${isUser ? 'bg-slate-700' : 'bg-purple-600'} flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid ${isUser ? 'fa-user' : 'fa-robot'} text-white text-xs"></i>
                    </div>
                    <div class="${isUser ? 'bg-emerald-500/10 border border-emerald-500/20 text-emerald-100' : 'bg-slate-800/80 text-slate-300'} p-4 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm max-w-[80%] markdown-content">
                        ${isLoading ? '<div class="animate-pulse">...</div>' : (isUser ? text.replace(/\n/g, '<br>') : marked.parse(text))}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function addSuggestionCard(task) {
            const list = document.getElementById('suggestions-list');
            if (list.querySelector('.text-center')) list.innerHTML = '';

            const html = `
                <div id="sugg-${task.id}" class="p-4 bg-slate-900/80 border border-purple-500/30 rounded-xl group hover:border-purple-400 transition animate-in zoom-in duration-300">
                    <h4 class="font-bold text-sm text-purple-100 mb-1 suggestion-title">${task.title}</h4>
                    <p class="text-xs text-slate-400 mb-3 suggestion-desc">${task.description}</p>
                    <div class="flex gap-2">
                        <button onclick="acceptSuggestion('${task.id}')" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg text-xs font-bold transition">Ajouter</button>
                        <button onclick="deleteSuggestion('${task.id}')" class="w-8 bg-slate-800 hover:text-red-400 text-slate-500 rounded-lg transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', html);
        }

        async function deleteSuggestion(id) {
            if (!confirm("Supprimer cette suggestion ?")) return;
            try {
                await fetch(`/api/brainstorm/suggestions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                document.getElementById('sugg-' + id).remove();
                updateSuggestionCount();
            } catch (err) { console.error(err); }
        }

        async function acceptSuggestion(id) {
            const el = document.getElementById('sugg-' + id);
            const title = el.querySelector('.suggestion-title').innerText;
            const desc = el.querySelector('.suggestion-desc').innerText;

            const btn = el.querySelector('button');
            btn.innerText = "...";

            try {
                // Create Task
                await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ project_id: projectId, description: title, long_description: desc, status: 'todo', suggestion_id: id })
                });

                // NO RELOAD - Just update UI
                // Remove the suggestion card from DOM
                el.remove();
                updateSuggestionCount();

                // Add to list visually
                allTasks.push({ id: Date.now(), description: title, status: 'todo' });
                renderTasks(allTasks);

            } catch (err) {
                alert("Erreur lors de l'ajout");
                btn.innerText = "Ajouter";
            }
        }

        function updateSuggestionCount() {
            const count = document.getElementById('suggestions-list').children.length;
            const placeholder = document.getElementById('suggestions-list').querySelector('.text-center');
            document.getElementById('suggestion-count').innerText = placeholder ? 0 : count;
        }

        async function loadLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="text-slate-500 text-sm">Chargement...</div>';
            const res = await fetch(`/api/projects/${projectId}/logs`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const logs = await res.json();
            container.innerHTML = logs.map(l => `
                <div class="relative pl-6 pb-6 border-l border-slate-700 last:border-0 last:pb-0">
                     <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full ${l.entry_type === 'antigravity' ? 'bg-purple-500 shadow-purple-500/50' : (l.entry_type === 'error' ? 'bg-red-500' : 'bg-emerald-500')} shadow-lg"></div>
                     <div class="glass-card p-4 rounded-xl border border-white/5">
                        <div class="flex justify-between items-center mb-2">
                             <span class="text-[10px] font-bold uppercase tracking-widest ${l.entry_type === 'antigravity' ? 'text-purple-400' : 'text-slate-400'}">${l.entry_type}</span>
                             <span class="text-[10px] font-mono text-slate-500">${new Date(l.created_at).toLocaleString()}</span>
                        </div>
                        <div class="text-slate-300 text-sm font-mono whitespace-pre-wrap">${l.content}</div>
                     </div>
                </div>
            `).join('');
        }

        function openLogModal() { document.getElementById('log-modal').classList.remove('hidden'); }
        function closeLogModal() { document.getElementById('log-modal').classList.add('hidden'); }

        async function submitNewLog() {
            const content = document.getElementById('new-log-content').value;
            const type = document.getElementById('new-log-type').value;
            await fetch('/api/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ project_id: projectId, content, entry_type: type })
            });
            closeLogModal();
            loadLogs();
        }
    </script>

    <!-- Logs Modal -->
    <div id="log-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-3xl p-8 border border-purple-500/30 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Nouvelle Entrée</h2>
            <div class="mb-4">
                <select id="new-log-type"
                    class="bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2">
                    <option value="log">Log Technique</option>
                    <option value="milestone">Milestone</option>
                    <option value="error">Erreur / Bug</option>
                </select>
                <textarea id="new-log-content"
                    class="w-full h-48 bg-slate-900/50 border border-white/10 rounded-xl p-4 text-slate-300 font-mono text-sm outline-none focus:border-purple-500"
                    placeholder="Contenu du log..."></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeLogModal()" class="text-slate-400 hover:text-white px-4">Annuler</button>
                <button onclick="submitNewLog()"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold">Enregistrer</button>
            </div>
        </div>
    </div>
    <!-- Edit Project Modal -->
    <div id="edit-project-modal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-3xl p-8 border border-white/10 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-6 uppercase italic">Modifier le Projet</h2>
            <input type="hidden" id="edit-project-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Nom</label>
                    <input type="text" id="edit-project-name"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Description</label>
                    <textarea id="edit-project-desc"
                        class="w-full h-32 bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-slate-300 outline-none focus:border-emerald-500 resize-none"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="closeEditProjectModal()"
                        class="text-slate-400 hover:text-white px-4">Annuler</button>
                    <button onclick="submitEditProject()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>